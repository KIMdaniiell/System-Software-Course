# Пароли пользователей

## Утилита passwd
Установка пароля пользователя (шифрование осуществляется средствами функции **crypt**)

## Файл shadow
Таблица содержащая пароли пользователей в зашифрованном виде

**Формат**:
  1. Имя пользователя
  2. Зашифрованный пароль
  3. Время последнего изменения пароля
  4. Количество дней, в течение которых пароль должен оставаться неизменным
  5. День истечения срока действия пароля
  6. Количество дней перед истечением срока действия пароля (в течение которых должно выводиться предупреждение)
  7. Количество дней после истечения срока действия пароля, по прошествии которых учетная запись должна быть отключена
  8. День, когда учетная запись была отключена
  9. *пока не имеет значения*

##  Утилита openssl
Другой способ создания учетных записей пользователей с паролями заключается в использовании параметра **-p** утилиты **useraddм,
но в случае использования данного параметра утилите необходимо передавать **уже зашифрованный пароль**.
Вы можете зашифровать пароль с помощью команды **openssl passwd**.
>  useradd -m -p $(openssl passwd hunter2) mohamed

+ значение **salt** может быть выбрано произвольным образом и будет отображаться в виде двух первых символов хэша
> $ openssl passwd -salt 42 hunter2
> 
> 42ZrbtP1Ze8G.

**Помните о том, что после выполнения данной команды ваш пароль в открытом виде будет сохранен в файле истории команд командной оболочки!**

## Шифрование ключевых фраз с помощью функции crypt
Стандартный вывод функции **crypt** генерируется с использованием алгоритма **DES**
```
#include <stdio.h>
#define __USE_XOPEN
#include <unistd.h>

int main(int argc, char** argv)
{
 if(argc==3)
   {
       printf("%s\n", crypt(argv[1],argv[2]));
   }
   else
   {
       printf("Использование: MyCrypt $пароль $salt\n" );
   }
  return 0;
}
```
> gcc MyCrypt.c -o MyCrypt -lcrypt

```
paul@rhel65:~$ ./MyCrypt hunter2 42  #Пароль - hunter2, соль - 42
42ZrbtP1Ze8G.
paul@rhel65:~$ ./MyCrypt hunter2 33  #Пароль - hunter2, соль - 33
33d6taYSiEUXI
```
+ Алгоритм **md5**
  по начальным символам значения **salt** - $$
  ```
  paul@rhel65:~$ ./MyCrypt hunter2 '$1$42'
  $1$42$7l6Y3xT5282XmZrtDOF9f0
  ```
  Длина значения **salt** для алгоритма **md5** может достигать **8** символов.
  Значения **salt** хранятся в открытом виде в строках файла **/etc/shadow** между вторым и третьим символами $,
  поэтому никогда **НЕ** используйте **строку пароля в качестве** значения **salt**!

## Файл /etc/login.defs
\- содержит некоторые стандартные значения параметров паролей пользователей, таких, как:
+ период устаревания паролей
+ ограничения длины паролей

## Утилита chage
+ **-l** - ознакомиться с текущими значениями этих параметров для указанного пользователя
+ **-E** - установка даты истечения срока действия пользовательской учетной записи
+ **-m** и **-M** - минимальный и максимальный срок действия пароля
+ дата истечения срока действия пароля
а также установки количества дней, в течение которых выводятся предупреждения об истечении срока действия пароля.
Многие из этих функций реализованы также и в рамках утилиты **passwd**.

## Блокировка учетных записей
Пароли из файла **/etc/shadow** не могут начинаться с символа восклицательного знака **'!'**
Если второе поле в строке из файла /etc/shadow начинается с символа восклицательного знака, пароль не может использоваться - **блокировка**, деактивация или отключение.
```
root@debian7:~# grep laura /etc/shadow | cut -c1-70
laura:$6$JYj4JZqp$stwwWACp3OtE1R2aZuE87j.nbW.puDkNUYVk7mCHfCVMa3CoDUJV
root@debian7:~# usermod -L laura      # Деактивировать пароль пользователя laura
root@debian7:~# grep laura /etc/shadow | cut -c1-70
laura:!$6$JYj4JZqp$stwwWACp3OtE1R2aZuE87j.nbW.puDkNUYVk7mCHfCVMa3CoDUJ
root@debian7:~# usermod -U laura      # Разблокировать
root@debian7:~# grep laura /etc/shadow | cut -c1-70
laura:$6$JYj4JZqp$stwwWACp3OtE1R2aZuE87j.nbW.puDkNUYVk7mCHfCVMa3CoDUJV

```
Пользователь root (а также пользователи с доступом к команде su посредством sudo) все так же будут иметь возможность использовать команду su для работы с учетной записью пользователя laura (так как в этом случае пароль пользователя не требуется). 

## Редактирование локальных файлов
В том случае, если вы все еще хотите отредактировать вручную файл **/etc/passwd** или **/etc/shadow**,
используйте утилиту **vipw** вместо непосредственного использования текстового редактора **vi(m)**.
Утилита **vipw** осуществляет корректную блокировку данного файла.
```
[root@RHEL5 ~]# vipw /etc/passwd
vipw: the password file is busy (/etc/ptmp present)
```
